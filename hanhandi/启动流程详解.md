# TEN 框架的启动流程解析

根据 `Taskfile.yml` 文件，当您运行 `task run` 命令时，系统会同时启动两个服务：

## 1. 服务器 (server)

```yaml
run:
  desc: run servers
  deps:
    - task: run-server
    - task: run-gd-server
```

`run` 任务依赖于两个子任务：

### a. run-server (后端 HTTP 服务器)

```yaml
run-server:
  desc: run backend http server
  cmds:
    - source .env && /app/server/bin/api
```

这个任务启动我们之前在[agents.default和server的关系.md](agents.default和server的关系.md)中讨论的 HTTP 服务器，它负责：
- 管理 Agent 的生命周期（启动、停止、保活）
- 处理配置修改
- 提供 API 接口

### b. run-gd-server (Graph Designer 服务器)

```yaml
run-gd-server:
  desc: run tman dev http server for graph designer
  dir: ./agents
  cmds:
    - tman designer
```

这个任务启动 Graph Designer 的 HTTP 服务器，它提供可视化界面用于：
- 设计和编辑 Agent 的处理图
- 配置扩展节点
- 可视化节点之间的连接

## 2. Agent 的启动方式

Agent 本身不是通过 `task run` 直接启动的，而是通过以下两种方式之一启动：

### a. 通过 server 的 API 启动

当您或客户端应用调用 server 的 `/start` API 时，server 会创建一个新的 Worker 进程来运行 Agent：

```
POST /start
{
  "channel_name": "test",
  "graph_name": "voice_assistant",
  ...
}
```

### b. 通过 `task use` 和配置文件

在运行 `task run` 之前，您通常会先运行：

```bash
task use AGENT=agents/examples/default
task build
```

这会：
1. 创建指向指定 Agent 配置的符号链接
2. 构建 Agent 和 server
3. 然后当您运行 `task run` 时，如果 Agent 配置中有 `auto_start: true` 的图，它会自动启动

## 完整启动流程

典型的启动流程是：

1. **选择 Agent 配置**：
   ```bash
   task use AGENT=agents/examples/default
   ```

2. **构建系统**：
   ```bash
   task build
   ```
   这会构建 Agent 和 server

3. **启动服务**：
   ```bash
   task run
   ```
   这会启动 server 和 Graph Designer 服务器

4. **通过 API 或自动启动运行 Agent**：
   - 如果配置中有 `auto_start: true` 的图，Agent 会自动启动
   - 或者通过调用 server 的 `/start` API 启动 Agent

所以，`task run` 命令本身启动的是服务器组件，而 Agent 实例则是通过这些服务器管理和启动的。这种设计使得系统可以动态地创建和管理多个 Agent 实例，每个实例可以有不同的配置和生命周期。
